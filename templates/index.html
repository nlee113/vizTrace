<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>vizTrace</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        #map { 
            height: 400px;
            margin-top: 20px; 
        }
        #traceForm {
            margin-bottom: 20px;
        }
        h1 {
            font-family: "Roboto", sans-serif;
            font-weight: 400;
            font-style: normal;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <h1>vizTrace</h1>
    <form id="traceForm" style="font-family: 'Roboto', sans-serif;">
        <label for="hostname" style="font-weight: 400; font-size: 12; font-style: normal;">Enter Website/Hostname:</label>
        <input type="text" id="hostname" name="hostname">
        <button type="submit">Trace</button>
    </form>
    <div id="map"></div>
    
    <script>
        $(document).ready(function () {
            console.log("test!");
            var map = L.map('map').setView([0, 0], 2);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
            }).addTo(map);

            var polyline;

            $('#traceForm').submit(function (event) {
                console.log("test 2!");
                event.preventDefault();
                var hostname = $('#hostname').val();
                $.ajax({
                    type: 'POST',
                    url: '/trace',
                    data: {hostname: hostname},  // Ensure 'hostname' contains the correct value
                    success: function (response) {
                        console.log("Received response from server:", response);
                        var route = response.route;
                        displayRoute(route);
                    },
                    error: function (xhr, status, error) {
                        console.error("Error fetching route data:", error);
                    }
                });
            });

            function displayRoute(route) {
                if (polyline) {
                    map.removeLayer(polyline);
                }
                var coordinates = [];
                var requestsCompleted = 0; // Track completed requests

                route.forEach(function (address) {
                    $.getJSON('https://ipinfo.io/' + address + '/geo', function (data) {
                        console.log("Received response for: " + address);
                        var loc = data.loc;
                        if (loc) {
                            var latlng = loc.split(',').map(parseFloat);
                            coordinates.push(latlng);
                        } else {
                            console.log("No location data found for: " + address);
                        }
                        requestsCompleted++;
                        if (requestsCompleted === route.length) {
                            if (coordinates.length > 0) {
                                polyline = L.polyline(coordinates, { color: 'blue' }).addTo(map);
                                map.fitBounds(polyline.getBounds());
                            } else {
                                console.log("No valid coordinates found for any addresses.");
                            }
                        }
                    }).fail(function () {
                        console.log("Failed to fetch data for: " + address);
                        requestsCompleted++;
                        if (requestsCompleted === route.length) {
                            console.log("No valid coordinates found for any addresses.");
                        }
                    });
                });
            }
        });
    </script>
</body>
</html>
